name: Deploy Admin to VPS

on:
  push:
    branches: [ main, master ]
    paths:
      - 'admin/**'
      - '.github/workflows/deploy-admin.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install dependencies
      run: npm install
      
    - name: Build admin panel
      env:
        VITE_API_BASE_URL: https://api.yashper.com
      run: npm run build
      
    - name: Create deployment archive
      run: |
        cd dist
        tar -czf ../admin-build.tar.gz .
        cd ..
        ls -lh admin-build.tar.gz
      
    - name: Deploy to VPS via SCP
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT }}
        source: "admin-build.tar.gz"
        target: "/tmp/"
        strip_components: 1
        timeout: 30s
        command_timeout: 10m
        
    - name: Extract and deploy on server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT }}
        timeout: 30s
        command_timeout: 10m
        script: |
          echo "ğŸš€ Starting admin panel deployment..."
          
          # Create backup
          if [ -d "/domains/admin.yashper.com/public_html" ]; then
            echo "ğŸ“¦ Creating backup..."
            tar -czf /tmp/admin-backup-$(date +%Y%m%d-%H%M%S).tar.gz -C /domains/admin.yashper.com/public_html . 2>/dev/null || true
          fi
          
          # Clear old files
          echo "ğŸ—‘ï¸  Removing old files..."
          rm -rf /domains/admin.yashper.com/public_html/*
          
          # Extract new build
          echo "ğŸ“‚ Extracting new build..."
          tar -xzf /tmp/admin-build.tar.gz -C /domains/admin.yashper.com/public_html/
          
          # Set permissions
          echo "ğŸ” Setting permissions..."
          chmod -R 755 /domains/admin.yashper.com/public_html/
          chown -R nobody:nobody /domains/admin.yashper.com/public_html/
          
          # Cleanup
          echo "ğŸ§¹ Cleaning up..."
          rm -f /tmp/admin-build.tar.gz
          
          # Verify deployment
          echo "âœ… Verifying deployment..."
          ls -la /domains/admin.yashper.com/public_html/
          
          if [ -f "/domains/admin.yashper.com/public_html/index.html" ]; then
            echo "âœ… Admin panel deployed successfully!"
            echo "ğŸŒ Admin: https://admin.yashper.com"
          else
            echo "âŒ Deployment failed - index.html not found!"
            exit 1
          fi
